[toc]

## 意义
- mysql 内置的复制功能是基于mysql 构建大规模、高性能应用的基础。
- 复制——提高可用性，可扩展性、容灾
- 复制——数据仓库
- 复制——降低主库的压力(读取操作可以从备库上实现)
> 在MySQL中，主从架构应该是最基础、最常用的一种架构了。后续的读写分离、多活高可用架构等大多都依赖于主从复制,MySQL默认采用异步复制方式。

### 数据分布
- 同步数据到不同的数据中心
### 负载均衡
- 将读操作分布到更多的服务器上去，实现对读密集型的应用进行优化。
### 备份
- 复制，可以看成数据备份的一种方式
### 高可用和容错
### 升级测试

## 复制的方式
- 实现原理就只在主库上记录二进制日志，在备库上重放的方式来实现的，这种实现方式就决定了延迟和主备不一致的存在
- 基于二进制文件位置的主从复制又可以称为传统复制，即从服务器依赖于主服务器的binlog文件位置，当主库发生数据变更时，binlog pos位点会增长，从库会感应到变化来完成同步。

### 实现原理(binlog 传统复制)

- master服务器将数据的改变记录二进制binlog日志，当master上的数据发生改变时，则将其改变写入二进制日志中。
- slave服务器会在一定时间间隔内对master二进制日志进行探测其是否发生改变，如果发生改变，则开始一个I/OThread请求master二进制事件。
- 同时主节点为每个I/O线程启动一个dump线程，用于向其发送二进制事件，并保存至从节点本地的中继日志中，从节点将启动SQL线程从中继日志中读取二进制日志，在本地重放，使得其数据和主节点的保持一致。

![image-20201127214035760](https://kingcall.oss-cn-hangzhou.aliyuncs.com/blog/img/2020/11/27/21:40:36-image-20201127214035760.png)


### 基于GTID的主从复制
- GTID是MySQL 5.6的新特性，其全称是Global Transaction Identifier，可简化MySQL的主从切换以及Failover。
- GTID用于在binlog中唯一标识一个事务。当事务提交时，MySQL Server在写binlog的时候，会先写一个特殊的Binlog Event，类型为GTID_Event，指定下一个事务的GTID，然后再写事务的Binlog。
- 在基于GTID的复制中，首先从服务器会告诉主服务器已经在从服务器执行完了哪些事务的GTID值，然后主库会有把所有没有在从库上执行的事务，发送到从库上进行执行，并且使用GTID的复制可以保证同一个事务只在指定的从库上执行一次，这样可以避免由于偏移量的问题造成数据不一致。
- 也就是说，无论是级联情况，还是一主多从的情况，都可以通过GTID自动找位置，而**无需像之前那样通过File_name和File_position找主库binlog位置了**。

#### 开启gtid
- gtid-mode = ON //开启gtid模式
- enforce-gtid-consistency = ON   //强制gtid一致性，用于保证启动gitd后事务的安全 

### 基于行的复制
- 在MySQL5.1 中被引入

### 基于语句的复制
- 逻辑复制，早在MySQL2.3 的时候就存在