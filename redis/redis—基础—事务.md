[toc]

## redis 事务
- multi、exec、discard、watch是Redis事务相关的命令

### 特性
#### 基于队列的实现
- Redis 事务的本质是一组命令的集合。事务支持一次执行多个命令，一个事务中所有命令都会被序列化。在事务执行过程，会按照顺序串行化执行队列中的命令，其他客户端提交的命令请求不会插入到事务执行命令序列中。
- 总结说：redis事务就是一次性、顺序性、排他性的执行一个队列中的一系列命令。

#### 不支持事务回滚
- **多数事务失败是由语法错误或者数据结构类型错误导致的**，语法错误说明在命令入队前就进行检测的，而类型错误是在执行时检测的，**Redis为提升性能而采用这种简单的事务，这是不同于关系型数据库的**，特别要注意区分

### 使用
####  multi: 开启事务
- multi执行之后，客户端可以继续向服务器发送任意条命令，这些命令不会立即被执行，而是放到一个队列中，等待EXEC执行的时候，队列中的命令才会被执行。

#### exec: 触发并执行事务中所有命令
- 执行完后，返回一个数组，数组组中的每一个元素都是执行队列命令产生的结果，而且顺序也和发送命令的顺序保持一致的。

####  discard: 清空事务队列
- 如果multi之后，exec之前，你调用了discard，那么队列里的命令就会被清空，放弃执行事务。

#### watch: 为事务提供check-and-set（CAS）行为
- 可以watch多个key,在EXEC之前，被监视的key如果至少有一个被修改了，那么整个事务就会被取消
- watch key1 key2 ... : 监视一或多个key,如果在事务执行之前，被监视的key被其他命令改动，则事务被打断 （ 类似乐观锁 ）
- unwatch : 取消watch对所有key的监控


## 失败处理机制

### exec之前失败
-  事务在exec之前可能会出错，比如说，命令可能会产生语法错误，或者其他更严重的错误，比如内存不足
-  服务器会对命令入队失败的情况进行记录，并在客户端调用 EXEC 命令时，拒绝执行并自动放弃这个事务。

### exec之后失败
-  命令可能在 EXEC调用之后失败。举个例子，事务中的命令可能处理了错误类型的键，比如将列表命令用在了字符串键上面，诸如此类。
-  由于redis 不支持回滚，需要开发人员自己处理

## 如何实现redis 真正的事务
- 通过redo-log 和 undo-log
>觉得可以通过封装一定的API实现，在执行操作的时候将当前的状态记录下来形成undo-log,将要执行的命令记录下来形成redo-log